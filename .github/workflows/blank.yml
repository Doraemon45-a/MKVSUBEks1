name: Convert MKV to MP4 and Upload to Google Drive

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: "URL file MKV"
        required: true
        default: "https://tipigd.tipikug.workers.dev/0:/MirrorFolder%20oleh%20kaelamirrorbot/Lilo.and.Stitch.2025.1080p.UHD.BluRay.x265.HDR.DV.DD+5.1-Pahe.in.mkv"

      output_name:
        description: "Nama file output MP4 (tanpa ekstensi)"
        required: true
        default: "video"

      drive_path:
        description: "Path folder tujuan di Google Drive"
        required: true
        default: "ConvertedVideos"

      ffmpeg_preset:
        description: "FFmpeg preset (ultrafast/superfast/veryfast/fast/medium)"
        required: false
        default: "veryfast"

      rclone_transfers:
        description: "Jumlah transfer concurrent rclone"
        required: false
        default: "4"

jobs:
  convert_and_upload:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository (subtitle.srt ikut ter-clone)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg rclone curl

      # 3️⃣ Setup rclone config dari secret base64
      - name: Setup rclone config (base64)
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONF_B64 }}" | base64 --decode > ~/.config/rclone/rclone.conf
          rclone listremotes

      # 4️⃣ Download MKV
      - name: Download MKV file
        run: |
          curl -L -o input.mkv "${{ github.event.inputs.source_url }}"

      # 5️⃣ Convert MKV ke MP4 (burn subtitle dari repository)
      - name: Convert MKV to MP4
        run: |
          ffmpeg -i input.mkv \
          -vf "scale=1920:1080,subtitles=subtitle.srt:charenc=UTF-8:force_style='Fontsize=18,MarginV=25'" \
          -r 24 \
          -c:v libx264 -preset ${{ github.event.inputs.ffmpeg_preset }} -crf 24 \
          -c:a aac -b:a 160k -ac 2 -af "volume=2.5" \
          -movflags +faststart "${{ github.event.inputs.output_name }}.mp4"

      # 6️⃣ Upload ke Google Drive
      - name: Upload to Google Drive
        run: |
          rclone copy "${{ github.event.inputs.output_name }}.mp4" \
            "gdrive:/${{ github.event.inputs.drive_path }}/" \
            -P --transfers=${{ github.event.inputs.rclone_transfers }} --checkers=8

      # 7️⃣ List folder di Google Drive (validasi)
      - name: List files in Google Drive
        run: |
          rclone lsl "gdrive:/${{ github.event.inputs.drive_path }}/"
