name: Convert MKV to MP4 and Upload to Google Drive

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: "URL file MKV"
        required: true

      output_name:
        description: "Nama file output MP4 (tanpa ekstensi)"
        required: true
        default: "video"

      drive_path:
        description: "Path folder tujuan di Google Drive"
        required: true
        default: "ConvertedVideos"

      ffmpeg_preset:
        description: "FFmpeg preset (ultrafast/superfast/veryfast/fast/medium)"
        required: false
        default: "veryfast"

      rclone_transfers:
        description: "Jumlah transfer concurrent rclone"
        required: false
        default: "4"

jobs:
  convert_and_upload:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg rclone curl

      # 3ï¸âƒ£ Setup rclone
      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONF_B64 }}" | base64 --decode > ~/.config/rclone/rclone.conf

      # 4ï¸âƒ£ Download MKV
      - name: Download MKV file
        run: |
          curl -L -o input.mkv "${{ github.event.inputs.source_url }}"

      # 5ï¸âƒ£ Convert MKV â†’ MP4 (subtitle dari repo)
      - name: Convert MKV to MP4
        run: |
          ffmpeg -i input.mkv \
          -vf "scale=1920:1080,subtitles=subtitle.srt:charenc=UTF-8:force_style='Fontsize=18,MarginV=25'" \
          -r 24 \
          -c:v libx264 -preset ${{ github.event.inputs.ffmpeg_preset }} -crf 24 \
          -c:a aac -b:a 160k -ac 2 -af "volume=2.5" \
          -movflags +faststart "${{ github.event.inputs.output_name }}.mp4"

      # 6ï¸âƒ£ Upload ke Google Drive
      - name: Upload to Google Drive
        run: |
          rclone copy "${{ github.event.inputs.output_name }}.mp4" \
            "gdrive:/${{ github.event.inputs.drive_path }}/" \
            -P --transfers=${{ github.event.inputs.rclone_transfers }}

      # âœ… Telegram SUCCESS
      - name: Telegram notify SUCCESS
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_CHAT_ID }}" \
          -d parse_mode="HTML" \
          -d text="âœ… <b>SUCCESS</b>%0AğŸ“ File: <code>${{ github.event.inputs.output_name }}.mp4</code>%0AğŸ“‚ Drive: <code>${{ github.event.inputs.drive_path }}</code>"

      # âŒ Telegram FAILED
      - name: Telegram notify FAILED
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_CHAT_ID }}" \
          -d parse_mode="HTML" \
          -d text="âŒ <b>FAILED</b>%0AğŸ“ File: <code>${{ github.event.inputs.output_name }}.mp4</code>%0AğŸ”— Source: <code>${{ github.event.inputs.source_url }}</code>"
